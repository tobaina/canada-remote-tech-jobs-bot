name: Post Canada Remote Tech Jobs

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * *" # 9am UTC daily

jobs:
  post_jobs:
    runs-on: ubuntu-latest

    steps:
      - name: Post jobs to Slack (robust)
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }} # channel ID OR channel name without #
        run: |
          python3 - <<'PY'
          import os, time, json
          from urllib.request import Request, urlopen
          from urllib.error import URLError, HTTPError

          SLACK_BOT_TOKEN = os.getenv("SLACK_BOT_TOKEN", "").strip()
          SLACK_CHANNEL = os.getenv("SLACK_CHANNEL", "").strip()

          if not SLACK_BOT_TOKEN or not SLACK_CHANNEL:
            print("âŒ Missing SLACK_BOT_TOKEN or SLACK_CHANNEL in GitHub Secrets.")
            raise SystemExit(1)

          JOBS_URL = "https://remotive.com/api/remote-jobs?category=software-dev"

          def fetch_json_with_retries(url, retries=4, backoff=2):
            last_err = None
            for attempt in range(1, retries + 1):
              try:
                req = Request(url, headers={"Accept": "application/json", "User-Agent": "github-actions-bot"})
                with urlopen(req, timeout=20) as resp:
                  content_type = resp.headers.get("Content-Type", "")
                  raw = resp.read().decode("utf-8", errors="replace").strip()

                  # If it is not JSON, do not crash the workflow (exit safely)
                  if "application/json" not in content_type and not raw.startswith("{"):
                    print("âš ï¸ API did not return JSON (maybe HTML / blocked). Exiting safely.")
                    print("First 300 chars:", raw[:300])
                    return None

                  try:
                    return json.loads(raw)
                  except json.JSONDecodeError:
                    print("âš ï¸ JSON decode failed. Exiting safely.")
                    print("First 300 chars:", raw[:300])
                    return None

              except (HTTPError, URLError) as e:
                last_err = e
                wait = backoff ** attempt
                print(f"âš ï¸ Fetch attempt {attempt} failed: {e}. Retrying in {wait}s...")
                time.sleep(wait)

            print("âŒ All fetch attempts failed:", last_err)
            return None

          def slack_post(text):
            payload = json.dumps({"channel": SLACK_CHANNEL, "text": text}).encode("utf-8")
            req = Request(
              "https://slack.com/api/chat.postMessage",
              data=payload,
              headers={
                "Authorization": f"Bearer {SLACK_BOT_TOKEN}",
                "Content-Type": "application/json; charset=utf-8"
              },
              method="POST"
            )
            with urlopen(req, timeout=20) as resp:
              body = resp.read().decode("utf-8", errors="replace")
              try:
                data = json.loads(body)
              except json.JSONDecodeError:
                print("âŒ Slack returned non-JSON:", body[:300])
                return False, {"raw": body}

              return data.get("ok", False), data

          data = fetch_json_with_retries(JOBS_URL)
          if not data:
            # Safe exit so your Action does not keep â€œfailingâ€
            print("âœ… Exiting safely (no valid jobs payload).")
            raise SystemExit(0)

          jobs = data.get("jobs", [])
          if not isinstance(jobs, list) or not jobs:
            print("âœ… No jobs found. Exiting safely.")
            raise SystemExit(0)

          # Post the first 5 jobs
          posted = 0
          for job in jobs[:5]:
            title = (job.get("title") or "").strip()
            company = (job.get("company_name") or "").strip()
            url = (job.get("url") or "").strip()

            if not title or not url:
              continue

            text = f"ðŸ’¼ *{title}*\nðŸ¢ {company}\nðŸ”— {url}"
            ok, resp = slack_post(text)

            if not ok:
              print("âŒ Slack post failed:", resp)
              # Common reasons:
              # - channel_not_found (wrong channel id/name)
              # - not_in_channel (bot not added to channel)
              # - missing_scope (token missing chat:write)
              # We stop here so you see the error clearly in Actions logs
              raise SystemExit(1)

            posted += 1
            time.sleep(1)

          print(f"âœ… Posted {posted} jobs successfully.")
          PY
